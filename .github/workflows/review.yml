name: Claude ChatGPT Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v3

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching PR diff..."
          gh pr diff ${{ github.event.pull_request.number }} > diff.txt

      - name: Call Claude API (ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ)
        id: claude
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat diff.txt | sed 's/"/\\"/g')
          PROMPT="ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’æ—¥æœ¬èªžã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚å‡ºåŠ›ã¯Markdownå½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚è¦³ç‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n\n- ãƒã‚°ã®å¯èƒ½æ€§\n- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ\n- å¯èª­æ€§ã‚„ä¿å®ˆæ€§\n- ãã®ä»–ã®æŽ¨å¥¨äº‹é …ã‚„æ”¹å–„ç‚¹\n\n\"\"\"diff\n${DIFF_CONTENT}\n\"\"\""

          jq -n --arg content "$PROMPT" '{
            model: "claude-sonnet-4-20250514",
            max_tokens: 2048,
            messages: [ { role: "user", content: $content } ]
          }' > claude_request.json

          curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $CLAUDE_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @claude_request.json > claude_response.json

          jq -r '.content[0].text' claude_response.json > claude_review.md

      - name: Call GPT-4o (Claudeãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆ)
        id: gpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CLAUDE_REVIEW=$(cat claude_review.md | sed 's/"/\\"/g')
          DIFF=$(cat diff.txt | sed 's/"/\\"/g')

          PROMPT="ä»¥ä¸‹ã¯Claudeã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã§ã™ã€‚ã¾ãŸã€å¯¾è±¡ã¨ãªã£ãŸPull Requestã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚‚ã‚ã‚ã›ã¦æä¾›ã—ã¾ã™ã€‚\n\nã‚ãªãŸã¯ç†Ÿç·´ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã—ã¦ã€æ¬¡ã®è¦³ç‚¹ã§ã‚³ãƒ¡ãƒ³ãƒˆãƒ»è£œè¶³ãƒ»ä¿®æ­£æ¡ˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š\n\n1. Claudeã®æŒ‡æ‘˜ã¯å¦¥å½“ã‹ï¼ŸéŽå‰°ãƒ»ä¸è¶³ã¯ã‚ã‚‹ã‹ï¼Ÿ\n2. Claudeã¨é‡è¤‡ã—ã¦ã„ãªã„æŒ‡æ‘˜ãŒã‚ã‚‹ã‹ï¼Ÿï¼ˆï¼è¿½åŠ ã§å¿…è¦ãªè¦³ç‚¹ï¼‰\n3. å…±é€šã—ã¦æŒ‡æ‘˜ã—ã¦ã„ã‚‹ã‚‚ã® â†’ ã€è¦ä¿®æ­£ã€‘\n   Claudeã®ã¿ or ã‚ãªãŸã®ã¿æŒ‡æ‘˜ã—ã¦ã„ã‚‹ã‚‚ã® â†’ ã€æŽ¨å¥¨ã€‘\n4. å„æŒ‡æ‘˜ã«ã¯å¯èƒ½ãªé™ã‚Šã€ä¿®æ­£æ¡ˆï¼ˆBefore / Afterã®ã‚³ãƒ¼ãƒ‰ä¾‹ï¼‰ã‚’ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§æç¤ºã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯æ—¥æœ¬èªžãƒ»Markdownå½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\n---\n\n### ðŸ’¬ Claudeã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ï¼š\n\n${CLAUDE_REVIEW}\n\n---\n\n### ðŸ§¾ PRã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ï¼š\n\n\"\"\"diff\n${DIFF}\n\"\"\""

          jq -n --arg content "$PROMPT" '{
            model: "gpt-4o",
            messages: [ { role: "user", content: $content } ]
          }' > gpt_request.json

          curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @gpt_request.json > gpt_response.json

          jq -r '.choices[0].message.content' gpt_response.json > final_review.md

      - name: Post Review to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Posting AI review to PR..."
          gh pr comment ${{ github.event.pull_request.number }} -F final_review.md
